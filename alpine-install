# Get some network
ip addr add 192.168.1.200/24 broadcast + dev eth0
ip link set dev eth0 up
ip route add 0.0.0.0/0 via 192.168.1.1
echo "nameserver 192.168.1.1" >> resolv.conf

# Setup repo
echo "https://dl-cdn.alpinelinux.org/alpine/v3.23/main" > /etc/apk/respositories
echo "https://dl-cdn.alpinelinux.org/alpine/v3.23/community" >> /etc/apk/respositories

apk update

# Setup partitions
apk add lsblk
apk add gptfdisk

# use gdisk to partition. fdisk is from busybox and it can't make GPT tables
# EFI System Partition = ef00
# gdisk seems mostly the same as fdisk so no problems there
gdisk /dev/sdb


# Format partitions
apk add e2fsprogs
mkfs.ext4 /dev/sdb2
apk add dosfstools
mkfs.vfat -F32 /dev/sdb1

# Mount partitions
mount /dev/sdb2 /mnt
mkdir /mnt/boot
mount /dev/sdb1 /mnt/boot

mkdir /mnt/dev
mount --bind /dev /mnt/dev

mkdir /mnt/proc
mount -t proc /proc /mnt/proc

mkdir /mnt/sys
mount -t sysfs /sys /mnt/sys


# Copy files needed from temp host
mkdir /mnt/etc
cp /etc/resolv.conf /mnt/etc/

mkdir -p /mnt/etc/apk/keys
cp /etc/apk/keys/* /mnt/etc/apk/keys/

cp /etc/apk/repositories /mnt/etc/apk/

# Install alpine-base
REPO="https://dl-cdn.alpinelinux.org/alpine/v3.23/main"
apk add --root /mnt --initdb --repository $REPO alpine-base

# chroot to new alpine host
chroot /mnt /bin/ash

# setup fstab
echo "/dev/sdb2 / ext4 defaults 0 1" >> /etc/fstab
echo "/dev/sdb1 /boot vfat defaults 0 2" > /etc/fstab

# install the rest of the packages you need for host setup
apk add intel-ucode linux-lts doas

# setup root password
passwd

# setup new user
adduser james
echo "permit persist alice as root" > /etc/doas.conf

# enable service to load modules of devices that exist on boot
rc-update add hwdrivers sysinit

# enable service to read and use /etc/fstab
rc-update add localmount boot


# back to temp host
exit

# Setup EFI Boot Manager
apk add efibootmgr

efibootmgr \
--create \
--disk /dev/sdb \
--part 1 \
--label "Alpine" \
--loader vmlinuz-lts \
--unicode ' root=/dev/sdb2 rootfstype=ext4 initrd=intel-ucode.img initrd=initramfs-lts loglevel=3'
